import React, { useMemo, useState, createContext, useContext, useEffect } from "react";
import { BrowserRouter as Router, Routes, Route, NavLink } from "react-router-dom";
import { motion } from "framer-motion";
import { Home as HomeIcon, Search as SearchIcon, Info as InfoIcon, Mail as MailIcon, Languages } from "lucide-react";

/**
 * Single-file React app (for Canvas preview) that mimics the requested
 * multi-page, multi-language site. We renamed the layout component to
 * `SiteLayout` to avoid any duplicate identifier issues like
 * "Identifier 'Layout' has already been declared".
 *
 * Pages: Home, Search, About, Contacts
 * Languages: EN (default), RU, DE
 */

// --- i18n dictionary ---------------------------------------------------------
const translations = {
  en: {
    home: "Home",
    search: "Search",
    about: "About Us",
    contacts: "Contacts",
    welcome: "Welcome to Our Website!",
    lead: "Premium design, modern stack, blazing-fast UX.",
    searchText: "Search for something...",
    aboutText:
      "We are a modern company with a passion for design and delightful user experiences.",
    contactsText: "Contact us through the form below.",
    name: "Name",
    email: "Email",
    message: "Message",
    send: "Send",
    langLabel: "Language",
    heroCta: "Explore",
    placeholderSearchExamples: "Examples: design, ui, brand",
  },
  ru: {
    home: "Главная",
    search: "Поиск",
    about: "О нас",
    contacts: "Контакты",
    welcome: "Добро пожаловать на наш сайт!",
    lead: "Дорогой дизайн, современный стек, молниеносный UX.",
    searchText: "Найдите что-нибудь...",
    aboutText:
      "Мы — современная команда со страстью к дизайну и удобным интерфейсам.",
    contactsText: "Свяжитесь с нами через форму ниже.",
    name: "Имя",
    email: "Email",
    message: "Сообщение",
    send: "Отправить",
    langLabel: "Язык",
    heroCta: "Смотреть",
    placeholderSearchExamples: "Например: дизайн, ui, бренд",
  },
  de: {
    home: "Startseite",
    search: "Suche",
    about: "Über uns",
    contacts: "Kontakte",
    welcome: "Willkommen auf unserer Website!",
    lead: "Edles Design, moderne Technik, blitzschnelles UX.",
    searchText: "Suche nach etwas...",
    aboutText:
      "Wir sind ein modernes Team mit Leidenschaft für Design und großartige UX.",
    contactsText: "Kontaktieren Sie uns über das Formular unten.",
    name: "Name",
    email: "E-Mail",
    message: "Nachricht",
    send: "Senden",
    langLabel: "Sprache",
    heroCta: "Entdecken",
    placeholderSearchExamples: "Beispiele: design, ui, marke",
  },
};

// --- i18n helpers ------------------------------------------------------------
const LangContext = createContext({ lang: "en", setLang: (v) => {} });
const useT = () => {
  const { lang } = useContext(LangContext);
  return (key) => translations[lang]?.[key] ?? translations.en[key] ?? key;
};

// --- UI helpers --------------------------------------------------------------
const Card = ({ children, className = "" }) => (
  <div className={`rounded-2xl shadow-lg bg-white/80 backdrop-blur p-6 ${className}`}>
    {children}
  </div>
);

// --- Layout (renamed to avoid duplicate identifier conflicts) ---------------
function SiteLayout({ children }) {
  const { lang, setLang } = useContext(LangContext);
  const t = useT();

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100">
      <header className="sticky top-0 z-20 border-b border-white/10 bg-slate-900/70 backdrop-blur">
        <div className="mx-auto max-w-6xl px-5 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-2xl bg-white/10 grid place-items-center">
              <Languages className="h-5 w-5" />
            </div>
            <span className="text-xl font-semibold tracking-tight">ModernSite</span>
          </div>
          <nav className="hidden md:flex items-center gap-6 text-sm">
            <NavLink to="/" end className={({ isActive }) =>
              `flex items-center gap-2 hover:text-white ${isActive ? "text-white" : "text-slate-300"}`
            }>
              <HomeIcon className="h-4 w-4" /> {t("home")}
            </NavLink>
            <NavLink to="/search" className={({ isActive }) =>
              `flex items-center gap-2 hover:text-white ${isActive ? "text-white" : "text-slate-300"}`
            }>
              <SearchIcon className="h-4 w-4" /> {t("search")}
            </NavLink>
            <NavLink to="/about" className={({ isActive }) =>
              `flex items-center gap-2 hover:text-white ${isActive ? "text-white" : "text-slate-300"}`
            }>
              <InfoIcon className="h-4 w-4" /> {t("about")}
            </NavLink>
            <NavLink to="/contacts" className={({ isActive }) =>
              `flex items-center gap-2 hover:text-white ${isActive ? "text-white" : "text-slate-300"}`
            }>
              <MailIcon className="h-4 w-4" /> {t("contacts")}
            </NavLink>
          </nav>
          <div className="flex items-center gap-3">
            <label htmlFor="lang" className="sr-only">{t("langLabel")}</label>
            <select
              id="lang"
              value={lang}
              onChange={(e) => setLang(e.target.value)}
              className="bg-slate-800 text-slate-100 border border-white/10 rounded-xl px-3 py-2"
            >
              <option value="en">EN</option>
              <option value="ru">RU</option>
              <option value="de">DE</option>
            </select>
          </div>
        </div>
      </header>

      <main className="mx-auto max-w-6xl px-5 py-10">
        {children}
      </main>

      <Footer />
    </div>
  );
}

function Footer() {
  return (
    <footer className="border-t border-white/10 mt-10">
      <div className="mx-auto max-w-6xl px-5 py-6 text-xs text-slate-400 flex items-center justify-between">
        <span>© {new Date().getFullYear()} ModernSite</span>
        <TestPanel />
      </div>
    </footer>
  );
}

// --- Pages -------------------------------------------------------------------
function PageContainer({ title, subtitle, children }) {
  return (
    <motion.div initial={{ opacity: 0, y: 12 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.4 }}>
      <div className="mb-6">
        <h2 className="text-3xl md:text-4xl font-bold tracking-tight text-white">{title}</h2>
        {subtitle && <p className="text-slate-300 mt-2 max-w-2xl">{subtitle}</p>}
      </div>
      <Card>{children}</Card>
    </motion.div>
  );
}

function HomePage() {
  const t = useT();
  return (
    <PageContainer title={t("welcome")} subtitle={t("lead")}>
      <div className="grid md:grid-cols-2 gap-8 items-center">
        <div className="space-y-4">
          <p className="text-slate-700 leading-relaxed">{t("aboutText")}</p>
          <button className="rounded-2xl px-5 py-3 bg-slate-900 text-white shadow hover:shadow-xl transition">
            {t("heroCta")}
          </button>
        </div>
        <div>
          <div className="h-48 md:h-60 w-full rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500" />
        </div>
      </div>
    </PageContainer>
  );
}

function SearchPage() {
  const t = useT();
  const [q, setQ] = useState("");
  const samples = useMemo(() => ["design systems", "branding", "ui motion", "typography"], []);
  const results = useMemo(() => {
    const query = q.trim().toLowerCase();
    if (!query) return [];
    return samples.filter((s) => s.includes(query));
  }, [q, samples]);

  return (
    <PageContainer title={t("search")} subtitle={t("placeholderSearchExamples")}>
      <div className="space-y-4">
        <div className="flex items-center gap-3">
          <div className="relative flex-1">
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder={t("searchText")}
              className="w-full rounded-xl border border-slate-200 bg-white/70 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            />
            <SearchIcon className="absolute right-3 top-3.5 h-5 w-5 text-slate-400" />
          </div>
        </div>
        <div>
          {q && results.length === 0 && (
            <p className="text-slate-500">No results for "{q}"</p>
          )}
          {results.length > 0 && (
            <ul className="list-disc ml-6 space-y-1 text-slate-700">
              {results.map((r) => (
                <li key={r}>{r}</li>
              ))}
            </ul>
          )}
        </div>
      </div>
    </PageContainer>
  );
}

function AboutPage() {
  const t = useT();
  return (
    <PageContainer title={t("about")}> 
      <div className="prose prose-slate max-w-none">
        <p>
          {t("aboutText")}
        </p>
        <p>
          We craft accessible, performant web apps with attention to detail,
          clean typography, and thoughtful motion.
        </p>
      </div>
    </PageContainer>
  );
}

function ContactsPage() {
  const t = useT();
  const [form, setForm] = useState({ name: "", email: "", message: "" });
  const [sent, setSent] = useState(false);

  function update(k, v) {
    setForm((f) => ({ ...f, [k]: v }));
  }

  function submit(e) {
    e.preventDefault();
    // Demo only: pretend to send
    setSent(true);
    setTimeout(() => setSent(false), 2000);
  }

  return (
    <PageContainer title={t("contacts")} subtitle={t("contactsText")}>
      <form className="grid gap-4" onSubmit={submit}>
        <div>
          <label className="block text-sm mb-1" htmlFor="name">{t("name")}</label>
          <input
            id="name"
            value={form.name}
            onChange={(e) => update("name", e.target.value)}
            className="w-full rounded-xl border border-slate-200 bg-white/70 px-4 py-3"
            placeholder={t("name")}
          />
        </div>
        <div>
          <label className="block text-sm mb-1" htmlFor="email">{t("email")}</label>
          <input
            id="email"
            type="email"
            value={form.email}
            onChange={(e) => update("email", e.target.value)}
            className="w-full rounded-xl border border-slate-200 bg-white/70 px-4 py-3"
            placeholder={t("email")}
          />
        </div>
        <div>
          <label className="block text-sm mb-1" htmlFor="message">{t("message")}</label>
          <textarea
            id="message"
            value={form.message}
            onChange={(e) => update("message", e.target.value)}
            rows={5}
            className="w-full rounded-xl border border-slate-200 bg-white/70 px-4 py-3"
            placeholder={t("message")}
          />
        </div>
        <div className="flex items-center justify-between">
          <button
            type="submit"
            className="rounded-2xl px-5 py-3 bg-indigo-600 text-white shadow hover:shadow-xl transition"
          >
            {t("send")}
          </button>
          {sent && <span className="text-sm text-green-600">✓ Sent (demo)</span>}
        </div>
      </form>
    </PageContainer>
  );
}

// --- Simple test harness -----------------------------------------------------
function runTests() {
  const tests = [];
  // 1) All locales include all EN keys
  const enKeys = Object.keys(translations.en);
  for (const locale of ["ru", "de"]) {
    const missing = enKeys.filter((k) => !(k in translations[locale]));
    tests.push({
      name: `Locale '${locale}' has all keys`,
      pass: missing.length === 0,
      details: missing.length ? `Missing: ${missing.join(", ")}` : "",
    });
  }
  // 2) Fallback: unknown key returns the key itself (by design here)
  const unknownKey = "__not_a_real_key__";
  const tFn = (lang) => (k) => translations[lang]?.[k] ?? translations.en[k] ?? k;
  tests.push({
    name: "Fallback returns the key if missing",
    pass: tFn("ru")(unknownKey) === unknownKey && tFn("de")(unknownKey) === unknownKey,
    details: "ru/de fallback for unknown key returns the key",
  });
  // 3) Navigation labels exist in all locales
  for (const key of ["home", "search", "about", "contacts"]) {
    const ok = ["en", "ru", "de"].every((loc) => !!translations[loc][key]);
    tests.push({ name: `Nav label '${key}' present`, pass: ok, details: ok ? "" : "Missing in some locale" });
  }
  // 4) Contact form labels exist
  for (const key of ["name", "email", "message", "send"]) {
    const ok = ["en", "ru", "de"].every((loc) => !!translations[loc][key]);
    tests.push({ name: `Contact field '${key}' present`, pass: ok, details: ok ? "" : "Missing in some locale" });
  }
  // 5) Search placeholder present
  const okSearch = ["en", "ru", "de"].every((loc) => !!translations[loc]["searchText"]);
  tests.push({ name: "Search placeholder present in all locales", pass: okSearch, details: okSearch ? "" : "Missing" });
  return tests;
}

function TestPanel() {
  const [open, setOpen] = useState(false);
  const [tests, setTests] = useState([]);
  useEffect(() => setTests(runTests()), []);

  return (
    <div className="text-left">
      <button
        onClick={() => setOpen((v) => !v)}
        className="rounded-xl border border-white/10 px-3 py-2 hover:bg-white/5"
      >
        {open ? "Hide" : "Show"} tests
      </button>
      {open && (
        <div className="mt-3 rounded-xl border border-white/10 p-3 bg-white/5 w-[22rem] max-w-[80vw]">
          {tests.map((t, i) => (
            <div key={i} className="flex items-start justify-between gap-3 py-1">
              <span className="text-slate-300">{t.name}</span>
              <span className={t.pass ? "text-green-400" : "text-red-400"}>{t.pass ? "PASS" : "FAIL"}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// --- App root ---------------------------------------------------------------
export default function App() {
  const [lang, setLang] = useState("en");

  return (
    <LangContext.Provider value={{ lang, setLang }}>
      <Router>
        <SiteLayout>
          <Routes>
            <Route path="/" element={<HomePage />} />
            <Route path="/search" element={<SearchPage />} />
            <Route path="/about" element={<AboutPage />} />
            <Route path="/contacts" element={<ContactsPage />} />
          </Routes>
        </SiteLayout>
      </Router>
    </LangContext.Provider>
  );
}
